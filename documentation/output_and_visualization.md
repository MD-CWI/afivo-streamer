# Saving output and visualization

[TOC]

Here, the various ways of visualizing the data generated by the simulations or to obtain certain data from the simulations are explained.

# Viewing results with Visit

By default, the simulations produce Silo files (`.silo`) for which the recommended viewer is [Visit](https://visit-dav.github.io/visit-website/). Extensive documentation is available on the website, but a brief summary of basic steps is given below.

## Opening a dataset

Open a simulation data set (a bunch of `.silo` files) using the 'Open' button.

![Open a database](images/visit-open-database.png){html: width=80%}

## Names of the variables

Which species are included depends on the chemistry input file, see the [chemistry documention](chemistry.md). Other important variables are:

name | description
--|--
e | Electron density (m^-3)
electric_fld | Electric field strength (V/m)
phi | Electric potential (V)
rhs | Right-hand side of Poisson equation (`-rho/epsilon_0`)
lsf | With an electrode: the level set function, zero at the electrode boundary
photo | With photoionization: the photoionization source term (m^-3 s^-1)
`M_min` | Negative ion species (if no chemistry is defined) (m^-3)
`M_plus` | Positive ion species (if no chemistry is defined) (m^-3)

## Visualizing 2D data

2D data can be visualized using the `Add -> Pseudocolor -> <variable name>` buttons. Afterwards, press the `Draw` button to draw the plot. By double-clicking on the resulting item, the properties of the plot can be adjusted (e.g., the color scale).

![2D Pseudocolor plot of electric field](images/visit-pseudocolor-example.png){html: width=80%}

## Visualizing 3D data

3D data can be visualized with `Pseudocolor` as well, and afterwards applying for example `Operators -> Slicing -> Slice`. Other options are volume rendering using `Volume` and surface plots using `Contour`.

## Making videos using VisIt

* The following link gives an overview on creating movies in VisIt: [Making movies in VisIt](https://www.visitusers.org/index.php?title=Making_Movies).

* To add/customize the appearance of stuff like legends, titles, time progress bar, go to `Controls -> Annotation` in the VisIt menu.

### Issues encountered and solutions:

* **Waiting message:** While making the videos using the default options, users may encounter a window saying 'VisIt is waiting for a CLI to launch on localhost'. This is due to the missing **xterm** package on the system. It can be installed using `sudo dnf install xterm`(Fedora) or `sudo apt-get install xterm` (Ubuntu).

* **Weird video generated:** The videos generated sometimes have a different color scheme or maybe the frames are inverted/mirrored. This was solved by installing the **ffmpeg** package using `sudo dnf install ffmpeg` (Fedora) or `sudo apt-get install ffmpeg` (Ubuntu).` 

* **Bad video quality/Custom videos:** The videos generated by VisIt maybe of bad quality or the user may want to make videos of a particular portion of the simulation domain. Then a set of PNG/JPEG images can be generated using VisIt, which can be suitably modified and made into a video using **ffmpeg** as follows:
  
    Suppose the set of PNG files are _movie0000.png_ ... _movie0032.png_ and the output video name is _resultVideo.mp4_, then the necessary command is

    ffmpeg -i movie%04d.png resultVideo.mp4

# Log files

Every simulation produces a log file `<output_name>_log.txt`. The log file is a text file containing information about the physics and numerical properties of the simulation. It is possible to write extra variables to the log file by defining the routine `user_log_variables()`, see `m_user_methods`.

Which variables the log file contains depends on the dimensionality of the run. Some relevant variables are:

name | meaning
---|---
`it` | simulation iteration
`time` | simulation time
`dt` | time step
`v` | estimate of streamer velocity (compared to last output)
`sum(n_e)` | integral of electron density
`sum(n_i)` | integral of first positive ion species
`sum(charge)` | integral of charge density (considering all species)
`max(E) x y` | maximum electric field + location
`max(n_e) x y` | maximum electron density + location
`max(E_r) x y` | maximum radial field + location
`voltage` | current applied voltage
`ne_zmin`, `ne_zmax` | Min/max location where the electron density exceeds a threshold
`max(Etip) x y` | Maximum electric field at streamer tip (tries to avoid boundaries) + location
`wc_time` | simulation wall-clock time (how long it has been running)
`n_cells` | number of grid cells used in simulation
`min(dx)` | minimum grid spacing
`highest(lvl)` | highest refinement level

There are several tools that can be used to view log files:

* `tools/plot_log_file.py`: loads a log file and plots the streamer velocity and maximum electric field. The radius is also shown, but only correctly for 2D axisymmetric discharges.
* `tools/plot_log_xy.py`: plot two quantities against from one or more log files.

Documentation for these tools is available by calling them with the `-h` argument.

# 1D lines

It is possible to extract output along a line using the following settings:

    [lineout]
        # Use this many points for lineout data:
        npoints = 500

        # Relative position of line maximum coordinate:
        rmax =  1.0000E+00  1.0000E+00

        # Relative position of line minimum coordinate:
        rmin =  0.0000E+00  0.0000E+00

        # Write output along a line:
        write = t

It is also possible to extract such data from normal Silo files using the `visit_lineout.py` script in the `tools` folder.

# Binary output and restarting

Afivo-streamer allows a simulation to be continued at a later time through the use of binary output files (`.dat` files). To do this, the simulation is initially run and set up to write DAT files, which could be achieved by using the following `.cfg` file options:

 * `datfile%%write` - set to true if you want to write DAT files
 * `datfile%%per_outputs` - control when DAT files are written by equating this to an integer (e.g. `datfile%%per_outputs = 20` means that a DAT file is created every after 20 output files are written)

To begin another simulation run from a particular `.dat` file, set the flag `restart_from_file` equal to a string with the name (and location, if in a different directory) of the `.dat` file you want to use as the starting point of the other simulation run.
